# Дисклеймер

Автора ДЗ немного накрыло от приёма разных полезных витаминок, поэтому в ДЗ присутсвуют всратые мемы, анекдоты и ссылки на ютуб  ¯\_(ツ)_/¯

Также я вроде бы понял что такое поддомен и боудед контекст, но так как я местами ссылаюсь на своё прошлое ДЗ, то я ничего не менял в плане нейминга, потому что времени нет, всё в последний момент и т.д.

![прошу понять и простить](./прошу_понять_и_простить.png)

# Intro

В ДЗ будет много отсылок ко второй домашке.

Её можно найти тут: https://github.com/dmmarkov/make-cats-free-again/tree/main/week-2

# Стейкхолдеры

## Список из урока
Топ-менеджмент
Менеджеры
Финотдел
Разработчики
Админы
Юристы
Клиенты

## Стейкхолдеры-потеряшки
Точно забыли позвать:
- котов из отдела расходников, а ведь им и расходниками заниматься, и с воркерами взаимодействовать, и печеньки принимать (будем считать, что заказ автоматизирован) - звучит как много функций, которые надо делать


Чисто в теории могли забыть:
- Где-то в уголке грустит тестировщик, потому что ему тестировать это всё руками или возможно ногами, потому что разработчики хотят, чтобы всё было надёжно
- Ни один дизайнер не высказал свои идеи по поводу UI/UX
- Возможно нужно было бы выслушать database administrator, но его забыли спросить, поэтому БД будет та, которую я выбрал =)
- Представители Золотой шляпы могли бы подсказать как не получить шляпу при интеграции с их системой
- DevOps'ы могли бы подсказать как сделать эффективный CI/CD, чтобы быстрее катить на прод оттестированную версию, потому что бизнес хочет низкий TTM. DevOps'ы с Админами могли бы устроить жёсткую зарубу на тему того сколько и каких раннеров кому надо
- Страшные ИБшники могли бы всем рассказать по чём куры в Кабарде, если в git полетят креденшиалы с прода
- Можно было бы позвать кондитеров на чай с печеньем, даже если толку будет ноль, то хотя бы чаёк с печеньками можно погонять =)

## Моя разбивка стейкхолдеров по группам
Моя авторская методика по разбивке стейкхолдеров на группы
![[в_очередь.meme.png]]

Матрица, как в уроке =)

![[MCF_(week 3)_Матрица_Влияние-Интерес.jpg]]

# Выбор архитектурного стиля

## Изменения которые добавили стейкхолдеры в систему

Я не переделывал ES, всё оставил как есть. Просто постараюсь притянуть за уши к чему-то рабочему =)

Борда с прошлого ДЗ: https://miro.com/app/board/uXjVMGQbi88=/?share_link_id=432822840988

У меня в прошлом ДЗ получились следующие контексты и неправильные поддомены:
- Отдел тестирования котов:
	- Проведение тестирование котов и отбор лучших
- Матчинг воркеров на заказы:
	- Матчинг воркеров на заказы
- Отдел сборки расходников:
	- Сборка расходников
	- Заказ печенек
- Печеньки из будущего:
	- Приготовить печеньку и отправить её в прошлое, чтобы успеть за 10 минут =)
- Воркеры и их работа с системой
	- Работа с заказами
	- Выплата денег
- Аудит заказов:
	- Проведение аудита заказов
- Ставки на заказы:
	- Приём ставок и расчёт выигрыша
- Заказы от клиентов
	- Работа с заказами от клиентов
	- Списание денег за услуги

В консёрнах от топов сказано, что они хотят скоринг потенциальных работников продавать отдельно и для него свой жизненный цикл, поэтому это новый боундед контекст. Получается будет 2 контекста в тестировании котов:
- Проведение тестирование котов
- Формирование пула воркеров по результатам тестирования


Менеджеры хотят спрятать систему ставок куда-то - видимо будет чёрная касса с той самой тетрадочкой

_Анекдот №777408_
```
Деревенский магазин горел, но никто не спешил его тушить. Все ждали, когда сгорит та самая ТЕТРАДКА...
```

Системы ставок как сервиса не будет ¯\_(ツ)_/¯.

Менеджеры сообщили, что заказов приходит сильно больше, чем они ожидали, поэтому система заявок от клиентов должна уметь хорошо масштабироваться, также как и система матчинга воркеров, потому что она принимает по сути такое же количество запросов, потому что на каждую заявку нужен новый worker

Финотдел хочет, чтобы мы могли добавлять новые варианты списания денег с клиентов. Требование не страшное, т.к. это отдельный контекст, то в нём просто появится немного логики относительно интеграции с выбранной системой. Это больше на код влияет.

К платёжным БД есть высокие требования по сохранности данных, чтобы им не сделали АТАТА разные службы.

Разработчики хотят, чтобы всё работало без сбоев или если сломалось, то было понятно где и что.
Админы также хотят простой мониторинг.

Это больше технические штуки:
- Чтобы не было сбоев надо покрывать код тестами (code coverage [наше всё](https://youtu.be/EgZaXQ-GJfc))
- Нам нужен какой-то инструмент трейсинга, поиск по логам (ELK/PLG)
- Простой мониторинг - это втащить метрики прометеуса во всё, что мы делаем как стандарт by-design =)

Учитывая бесплатность инфраструктуры, то вот эти штуки можно творить как угодно.

Юристы хотят, чтобы всё соответствовало правовым нормам. Ну... Азартные игры мы в систему не будем впиливать. В целом надо соблюсти какие-то CatFinComplience и видимо будет достаточно.

В прошлом ДЗ я выделил следующие основные характеристики на всю систему:
- agility
- testability
- deployability
- performance
- availability
- fault tolerance
- security
- scalability

Также ещё добавились:
- consistency - это относительно финансов
- modularity - для того чтобы можно было отдельно продать
- modifiability - это особенно актуально для скоринга новых воркеров и системы списания денег
- maintainability - в целом хотят для всей системы
- общий релизный цикл - 1 месяц
- для скоринга новых воркеров - 1 неделя
- evolvability - менеджеры уже 1 раз ошиблись в нагрузках, в следующий раз может оказаться что заявок от клиентов в разы больше или клиентов станет больше и общая нагрузка вырастет. Надо предусмотреть возможность изменения системы.
- simplicity - для системы списания денег нужно иметь возможность легко добавить новую платёжную систему.

Т.к. есть отдельные требования к разным частям системы, то вся система точно не монолит.

На ES у меня много отправки в другие контексты, где потом используется read-model (возможно я добавлю чуть команд для улучшения читаемости). Это близко к event-driven архитектурно, к тому же event-driven позволяет реализовывать отдельные части как угодно.

Для дальнейшей детализации я раскидал по контекстам требования, чтобы дальше работать с каждым куском.

На данном этапе я предполагаю, что один контекст == один сервис

## Общие требования
Если сложить то, что было во 2 ДЗ, и то что было найдено по информации стейкхолдеров, то будет такой общий список:
- agility
- testability
- deployability
- performance
- availability
- fault tolerance
- security
- scalability
- maintainability
- evolvability

## Специфичные требования на отдельные контексты

В тех пунктах, где нет дополнительных пунктов - это значит, что они подчиняются общим требованиям и я не нашёл ничего специфичного.

- Отдел тестирования котов:
	- Проведение тестирование котов
		- modularity
		- modifiability
		- high model complexity (core)
		- релизный цикл 1 неделя
		- защита от ddos
	- Формирование пула воркеров по результатам тестирования
- Матчинг воркеров на заказы:
	- Матчинг воркеров на заказы
		- high model complexity (core)
		- scalability
		- evolvability
- Отдел сборки расходников:
	- Сборка расходников
	- Заказ печенек
- Печеньки из будущего:
	- Приготовить печеньку и отправить её в прошлое, чтобы успеть за 10 минут =) - это внешний элемент на который мы не влияем, поэтому дальше его не будет
- Воркеры и их работа с системой
	- Работа с заказами
		- fault tolerance
		- security
		- scalability - т.к. растёт входящий поток заказов, то будет расти и поток заказов падающий на воркеров
		- evolvability - для меня это следствие пункта выше
	- Выплата денег
		- соответствие CatFinComplience
		- fault tolerance
		- security
- Аудит заказов:
	- Проведение аудита заказов
- Ставки на заказы:
	- Приём ставок и расчёт выигрыша - будет под ковром спрятано, поэтому вообще не берём в расчёт
- Заказы от клиентов
	- Работа с заказами от клиентов
		- fault tolerance
		- security
		- scalability - менеджеры ошиблись в своих расчётах и лучше бы здесь чуть больше добавить возможностей по масштабированию
		- evolvability - для меня это следствие пункта выше
	- Списание денег за услуги
		- соответствие CatFinComplience
		- fault tolerance
		- security
		- agility


## Общий архитектурный стиль

Согласно таблице из урока по применимости разных стилей

![[style_compare.png]]

лучше всего подходят **микросервисы**, т.к. у них самые высокие agility, deployability, modulatiry, modifiability, security, testability

## Поиск атомарных элементов

### Общий список элементов:
- Проведение тестирование котов
- Формирование пула воркеров по результатам тестирования
- Матчинг воркеров на заказы
- Сборка расходников
- Заказ печенек
- Работа с заказами (воркеры)
- Выплата денег (воркеры)
- Проведение аудита заказов
- Работа с заказами от клиентов
- Списание денег за услуги

### Сразу можно выделить в отдельные элементы
- Проведение тестирование котов - хотят продавать отдельно в перспективе+релизный цикл в 1 неделю+есть требование выдерживать ddos
- Матчинг воркеров на заказы - тут очень специфичные алгоритмы, нейминг, плюс шаги должны как-то меняться, поэтому отдельный сервис
- Сборка расходников - это часть generic поддомена, который в принципе может быть внешней системой
- Работу с заказами для воркера
- Работа с заказами для клиента - требуется чтобы работало без тупняков и держало нагрузку

### Отдельный сервис на основе характеристик
- Выплата денег (воркеры) - отдельный сервис, который скорее всего будет написан, оттестирован и не будет трогаться в дальнейшем
- Списание денег за услуги - тут есть всякие скидки, также планируются новые способы списания денег, поэтому отдельный сервис, который будет жить своей жизнью

### Объединить в один сервис
- Формирование пула воркеров по результатам тестирования я объединю с сервисом проведения тестирования котов, потому что по сути пул воркеров - это просто список котов, который успешно прошёл тестирование. Технически - это просто запрос к БД успешно прошедших тестирование. Каких-то спефических требований к нему нет.
- Заказ печенек - это просто "функция" которая добавляет специфичный расходник в корзину расходников, поэтому она будет частью системы сборки расходников.

### Последний герой
- Проведение аудита заказов - элемент без каких-то специфичных требований, но требует данных о заказах. Если объединять с другими, то будет как не пришей кобыле хвост, поэтому просто

### Итоговый список сервисов
- Проведение тестирование котов+Формирование пула воркеров по результатам тестирования
- Матчинг воркеров на заказы
- Сборка расходников+Заказ печенек
- Работа с заказами (воркеры)
- Работа с заказами от клиентов
- Проведение аудита заказов
- Выплата денег (воркеры)
- Списание денег за услуги

Зелёный фон - это сервисы, которые надо делать

![[MCF_(week 3)_схема сервисов 2.jpg]]

### Специфика конкретного сервиса (стиль + БД)
- Проведение тестирование котов+Формирование пула воркеров по результатам тестирования
	- Стиль: Service-Based, потому что есть БД
	- БД: Key-Value - есть вопросы в тесте, есть ответы, есть кандидат с набором тестов, хорошо скейлится
- Матчинг воркеров на заказы
	- Стиль: Pipeline - из описания понятно, что есть какой-то пайплайнинг и перестановка шагов
	- БД: NewSQL - ну просто потому что непонятно что они там творят, требований к консистентности нет, а в остальном средний вариант относительно всех показателей
- Сборка расходников+Заказ печенек
	- Стиль: layered-монолит - потому что ничего специфичного не надо, нужно просто чтобы работало
	- БД: RDBMS - простота изучения, отсутствие каких-то требований
- Работа с заказами (воркеры)
	- Стиль: Service-Based, потому что есть БД
	- БД: NewSQL - в целом балансное решение по производительности и возможностям масштабированию
- Работа с заказами от клиентов
	- Стиль: Service-Based, потому что есть БД
	- БД: NewSQL - в целом балансное решение по производительности и возможностям масштабированию
- Проведение аудита заказов
	- Стиль: layered-монолит - потому что ничего специфичного не надо, нужно просто чтобы работало
	- БД: RDBMS - простота изучения, отсутствие каких-то требований
- Выплата денег (воркеры)
	- Стиль: layered-монолит - потому что ничего специфичного не надо, нужно просто чтобы работало
	- БД: RDBMS - основной критерий это consistency
- Списание денег за услуги
	- Стиль: Microkernel - потому что хотят внедрять новые системы списания денег
	- БД: RDBMS - основной критерий это consistency

### Стиль коммуникаций между сервисами
Я выбрал просто микросервисный стиль, потому что он лучше с точки зрения коммуникаций.

В этом случае решил, что все вызовы будут синхронными, где каждый сервис ходит к другим и просто поллингом забирает нужную себе информацию.

Из минусов - если сервис с которого тянут данные отваливается, то при поллинге будут ошибки, которые видимо можно игнорировать какое-то время, а с другой стороны админам будет видно кто и кого не видит.

# Фитнес-функции
У меня будет экосистема на Go

Для повышения надёжности нужно хорошее покрытие тестами.

Для Go можно стандартными средствами узнать CodeCoverage

Так как явных требований нет, то предлагают для системы считать необходимый Coverage=80%

Для взаимодействия между сервисами будем использовать gRPC, т.к. вызовы синхронные.

gRPC строится поверх protobuf, по схеме.

Схему передачи данных, чтобы передаётся нужное придётся валидировать руками.

Но для того, чтобы API не сломалось можно использовать buf, который позволяет отлавливать breaking changes. Валидацию через buf можно встроить в CI.

Для того чтобы убедится, что flow взаимодействия между сервисами работает верно предлагаю использовать e2e-тесты хотя бы в варианте взаимодействия 3х сервисов между собой.

Для нагруженных сервисов (сервис по скорингу воркеров) необходимо добавить нагрузочные тесты.

Остальное придётся валидировать руками-глазами по коду =(

Надо по методичке проверять, что сервисы оплаты соответствуют CatFinComplience

# ADR
*Title*: MCF-001: Сервис оплаты работы воркеров

*Status*: Proposed

*Context*: В ES модели биллинговые системы для списания денег с клиентов и оплаты работы воркеров были выделены в отдельные контексты.
Консёрны фин.отдела говорят, что система оплаты труда воркеров меняться не будет, а для списания денег с клиентов нужны будут новые механизмы.
Все финансовые сервисы должны соответствовать CatFinComplience. Стейкхолдеры также требуют надёжное хранение данных.

*Decision*: Вынести в отдельный сервис, покрыть его юнит и сервисными тестами. Особое внимание уделить тому, чтобы сервис не падал если вдруг Золотая шляпа перестанет с нами дружить.

*Consequences*: Из-за того что сервис должен быть надёжным, то он требует много внимания. Но из плюсов - это внимание нужно один раз. Если всё будет работать как надо, то напишем, проверим, запустим и будет хорошо.

*Compliance*: Правильность работы сервиса должна проверяться с помощью сервисных тестов. По методичке надо проверить соответствие CatFinComplience.

*Notes*: Из-за необходимости взаимодействия с внешним сервисом этот самый сервис может подводить нас. В тестах мы можем заглушками закрыть API и только предусмотреть недоступность внешней системы.
